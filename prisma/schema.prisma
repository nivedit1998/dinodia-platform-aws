generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum Role {
  ADMIN
  INSTALLER
  TENANT
}

enum HomeStatus {
  ACTIVE
  TRANSFER_PENDING
  UNCLAIMED
}

enum MatterCommissioningStatus {
  CREATED
  IN_PROGRESS
  NEEDS_INPUT
  SUCCEEDED
  FAILED
  CANCELED
}

enum CommissioningKind {
  MATTER
  DISCOVERY
}

enum AuditEventType {
  SELL_INITIATED
  CLAIM_CODE_GENERATED
  HOME_CLAIM_ATTEMPTED
  HOME_RESET
  OWNER_TRANSFERRED
  HOME_CLAIMED
}

enum AuthChallengePurpose {
  ADMIN_EMAIL_VERIFY
  TENANT_ENABLE_2FA
  LOGIN_NEW_DEVICE
  REMOTE_ACCESS_SETUP
  PASSWORD_RESET
  SUPPORT_HOME_ACCESS
  SUPPORT_USER_REMOTE_SUPPORT
}

enum DeviceStatus {
  ACTIVE
  STOLEN
  BLOCKED
}

enum StepUpPurpose {
  REMOTE_ACCESS_SETUP
}

enum SupportRequestKind {
  HOME_ACCESS
  USER_REMOTE_ACCESS
}

model Home {
  id                 Int           @id @default(autoincrement())
  status             HomeStatus    @default(ACTIVE)
  addressLine1       String
  addressLine2       String?
  city               String
  state              String?
  postcode           String
  country            String
  haConnection       HaConnection  @relation(fields: [haConnectionId], references: [id])
  haConnectionId     Int           @unique
  claimCodeHash      String?       @unique
  claimCodeIssuedAt  DateTime?
  claimCodeConsumedAt DateTime?
  auditEvents        AuditEvent[]
  users              User[]
  automationOwnerships AutomationOwnership[]
  hubInstall         HubInstall?   @relation("HomeHubInstall")
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
}

model AuditEvent {
  id           String         @id @default(uuid())
  type         AuditEventType
  metadata     Json?
  home         Home           @relation(fields: [homeId], references: [id])
  homeId       Int
  actorUser    User?          @relation("AuditEventActor", fields: [actorUserId], references: [id])
  actorUserId  Int?
  createdAt    DateTime       @default(now())

  @@index([homeId])
  @@index([actorUserId])
}

model AuditEventArchive {
  id          String         @id @default(uuid())
  type        AuditEventType
  metadata    Json?
  homeId      Int?
  actorUserId Int?
  createdAt   DateTime
  archivedAt  DateTime       @default(now())
}

model User {
  id                Int           @id @default(autoincrement())
  username          String        @unique
  passwordHash      String
  email             String?
  emailPending      String?
  emailVerifiedAt   DateTime?
  email2faEnabled   Boolean       @default(false)
  role              Role          @default(TENANT)
  home              Home?         @relation(fields: [homeId], references: [id])
  homeId            Int?
  haConnection      HaConnection? @relation("AssignedHaConnection", fields: [haConnectionId], references: [id])
  haConnectionId    Int?
  ownedHaConnection HaConnection? @relation("OwnedHaConnection")
  accessRules       AccessRule[]
  alexaAuthCodes    AlexaAuthCode[]
  alexaRefreshTokens AlexaRefreshToken[]
  alexaEventToken   AlexaEventToken?
  newDeviceCommissioningSessions NewDeviceCommissioningSession[]
  automationOwnerships AutomationOwnership[]
  trustedDevices    TrustedDevice[]
  authChallenges    AuthChallenge[]
  stepUpApprovals   StepUpApproval[]
  remoteAccessLeases RemoteAccessLease[]
  actedAuditEvents  AuditEvent[] @relation("AuditEventActor")
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  @@index([homeId])
}

model TrustedDevice {
  id          String   @id @default(uuid())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      Int
  deviceId    String
  label       String?
  firstSeenAt DateTime @default(now())
  lastSeenAt  DateTime @default(now())
  revokedAt   DateTime?
  sessionVersion Int   @default(0)

  @@unique([userId, deviceId])
  @@index([userId])
  @@index([deviceId])
}

model DeviceRegistry {
  deviceId    String       @id
  status      DeviceStatus @default(ACTIVE)
  label       String?
  firstSeenAt DateTime     @default(now())
  lastSeenAt  DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model AuthChallenge {
  id         String               @id @default(uuid())
  user       User                 @relation(fields: [userId], references: [id])
  userId     Int
  purpose    AuthChallengePurpose
  email      String
  deviceId   String?
  tokenHash  String               @unique
  expiresAt  DateTime
  approvedAt DateTime?
  consumedAt DateTime?
  createdAt  DateTime             @default(now())

  @@index([userId])
  @@index([expiresAt])
  @@index([approvedAt])
}

model StepUpApproval {
  id         String        @id @default(uuid())
  user       User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId     Int
  deviceId   String
  purpose    StepUpPurpose
  approvedAt DateTime      @default(now())
  usedAt     DateTime?
  createdAt  DateTime      @default(now())

  @@index([userId, deviceId, purpose])
  @@index([deviceId])
}

model RemoteAccessLease {
  id        String       @id @default(uuid())
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    Int
  deviceId  String
  purpose   StepUpPurpose
  tokenHash String       @unique
  expiresAt DateTime
  revokedAt DateTime?
  createdAt DateTime     @default(now())

  @@index([userId, deviceId, purpose])
  @@index([expiresAt])
  @@index([deviceId])
}

model HaConnection {
  id             Int    @id @default(autoincrement())
  baseUrl        String // e.g. https://xxxx.ui.nabu.casa or http://homeassistant.local:8123
  cloudUrl       String? // optional HA Cloud URL shared across admin + tenants
  haUsername     String?
  haUsernameCiphertext String?
  haPassword     String?
  haPasswordCiphertext String?
  longLivedToken String?
  longLivedTokenCiphertext String?
  longLivedTokenHash String? @unique
  devicesVersion Int    @default(0)

  owner   User? @relation("OwnedHaConnection", fields: [ownerId], references: [id])
  ownerId Int?  @unique

  home      Home?
  users     User[]   @relation("AssignedHaConnection")
  devices   Device[]
  monitoringReadings MonitoringReading[]
  newDeviceCommissioningSessions NewDeviceCommissioningSession[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model HubInstall {
  id                          String     @id @default(uuid())
  serial                      String     @unique
  bootstrapSecretCiphertext   String
  syncSecretCiphertext        String?
  platformSyncEnabled         Boolean    @default(true)
  platformSyncIntervalMinutes Int        @default(2)
  rotateEveryMinutes          Int        @default(60)     // minutes
  graceMinutes                Int        @default(20)     // minutes
  publishedHubTokenVersion    Int        @default(0)
  lastAckedHubTokenVersion    Int        @default(0)
  lastReportedLanBaseUrl      String?
  lastReportedLanBaseUrlAt    DateTime?
  lastSeenAt                  DateTime?
  home                        Home?      @relation("HomeHubInstall", fields: [homeId], references: [id], onDelete: SetNull)
  homeId                      Int?       @unique
  hubTokens                   HubToken[]
  createdAt                   DateTime   @default(now())
  updatedAt                   DateTime   @updatedAt
}

enum HubTokenStatus {
  PENDING
  ACTIVE
  GRACE
  REVOKED
}

model HubToken {
  id               String          @id @default(uuid())
  hubInstall       HubInstall      @relation(fields: [hubInstallId], references: [id], onDelete: Cascade)
  hubInstallId     String
  version          Int
  status           HubTokenStatus
  tokenHash        String
  tokenCiphertext  String
  publishedAt      DateTime?
  graceUntil       DateTime?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  @@unique([hubInstallId, version])
  @@unique([hubInstallId, tokenHash])
  @@index([hubInstallId, status])
  @@index([tokenHash])
}

model HubAgentNonce {
  id        Int      @id @default(autoincrement())
  serial    String
  nonce     String
  ts        BigInt
  createdAt DateTime @default(now())

  @@unique([serial, nonce])
  @@index([createdAt])
}

model AccessRule {
  id        Int      @id @default(autoincrement())
  user      User     @relation(fields: [userId], references: [id])
  userId    Int
  // Tenants are now associated to an AREA only
  area      String
  createdAt DateTime @default(now())
}

model Device {
  id             Int          @id @default(autoincrement())
  haConnection   HaConnection @relation(fields: [haConnectionId], references: [id])
  haConnectionId Int

  entityId String
  name     String
  area     String?
  label    String?
  blindTravelSeconds Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([haConnectionId, entityId])
}

model MonitoringReading {
  id             Int          @id @default(autoincrement())
  haConnection   HaConnection @relation(fields: [haConnectionId], references: [id])
  haConnectionId Int
  entityId       String
  state          String
  numericValue   Float?
  unit           String?
  capturedAt     DateTime     @default(now())

  @@index([haConnectionId, entityId, capturedAt])
}

model AlexaAuthCode {
  id          Int      @id @default(autoincrement())
  code        String   @unique
  user        User     @relation(fields: [userId], references: [id])
  userId      Int
  clientId    String
  redirectUri String
  expiresAt   DateTime
  used        Boolean  @default(false)
  createdAt   DateTime @default(now())
}

model AlexaRefreshToken {
  id        Int      @id @default(autoincrement())
  tokenHash String   @unique
  user      User     @relation(fields: [userId], references: [id])
  userId    Int
  clientId  String
  revoked   Boolean  @default(false)
  revokedAt DateTime?
  createdAt DateTime @default(now())
}

model AlexaEventToken {
  id           Int      @id @default(autoincrement())
  user         User     @relation(fields: [userId], references: [id])
  userId       Int      @unique
  accessToken  String
  refreshToken String
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model NewDeviceCommissioningSession {
  id                  String                     @id @default(uuid())
  user                User                       @relation(fields: [userId], references: [id])
  userId              Int
  haConnection        HaConnection               @relation(fields: [haConnectionId], references: [id])
  haConnectionId      Int
  requestedArea       String
  requestedName       String?
  requestedDinodiaType String?
  requestedHaLabelId  String?
  setupPayloadHash    String?
  manualPairingCodeHash String?
  haFlowId            String?
  status              MatterCommissioningStatus  @default(CREATED)
  kind                CommissioningKind          @default(MATTER)
  error               String?
  lastHaStep          Json?
  beforeDeviceIds     Json?
  beforeEntityIds     Json?
  afterDeviceIds      Json?
  afterEntityIds      Json?
  createdAt           DateTime                   @default(now())
  updatedAt           DateTime                   @updatedAt

  @@index([userId])
  @@index([haConnectionId])
  @@index([haFlowId])
  @@index([kind])
}

model AutomationOwnership {
  id           Int      @id @default(autoincrement())
  home         Home     @relation(fields: [homeId], references: [id])
  homeId       Int
  user         User     @relation(fields: [userId], references: [id])
  userId       Int
  automationId String
  createdAt    DateTime @default(now())

  @@index([homeId])
  @@index([userId])
  @@index([automationId])
  @@unique([automationId, homeId])
}

model SupportRequest {
  id              String             @id @default(uuid())
  kind            SupportRequestKind
  homeId          Int
  targetUserId    Int?
  installerUserId Int
  authChallengeId String             @unique
  createdAt       DateTime           @default(now())

  @@index([homeId])
  @@index([targetUserId])
  @@index([installerUserId])
}
